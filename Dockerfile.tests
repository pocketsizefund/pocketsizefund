FROM python:3.12

COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    libc6-dev \
    linux-libc-dev \
    && rm -rf /var/lib/apt/lists/*

ENV PYTHON=1

WORKDIR /tests

COPY pyproject.toml uv.lock ./

COPY applications/datamanager/pyproject.toml ./applications/datamanager/

COPY applications/portfoliomanager/pyproject.toml ./applications/portfoliomanager/

COPY applications/models/pyproject.toml ./applications/models/

COPY infrastructure/pyproject.toml ./infrastructure/

COPY libraries/python/pyproject.toml ./libraries/python/

RUN uv sync --all-packages --all-groups

COPY applications/ ./applications/

COPY libraries/ ./libraries/

RUN uv sync --all-packages --all-groups

RUN mkdir -p /tests/coverage_output
